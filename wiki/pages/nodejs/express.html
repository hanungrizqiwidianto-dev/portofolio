<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Express.js Framework - Node.js Development</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div id="sidebarContainer"></div>

    <div class="container">
        <main class="content">
            <div class="page-header">
                <div class="breadcrumb">
                    <a href="../../index.html">Home</a>
                    <span>/</span>
                    <a href="#">Node.js Development</a>
                    <span>/</span>
                    <span>Express.js Framework</span>
                </div>
                <h1><i class="fab fa-node-js"></i> Express.js - Fast, Minimalist Web Framework</h1>
                <p class="page-description">Build robust web applications and APIs with Express.js, the most popular
                    Node.js framework.</p>
            </div>

            <div class="content-section">
                <h2><i class="fas fa-rocket"></i> Getting Started</h2>
                <pre><code># Install Express
npm install express

# Basic Express server
const express = require('express');
const app = express();
const port = 3000;

// Middleware for parsing JSON
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Simple route
app.get('/', (req, res) => {
    res.json({ message: 'Hello Express!' });
});

// Start server
app.listen(port, () => {
    console.log(`Server running on http://localhost:${port}`);
});</code></pre>
            </div>

            <div class="content-section">
                <h2><i class="fas fa-code"></i> Complete REST API Example</h2>
                <pre><code>const express = require('express');
const app = express();

// Middleware
app.use(express.json());

// In-memory database
let users = [
    { id: 1, name: 'John Doe', email: 'john@example.com', age: 30 },
    { id: 2, name: 'Jane Smith', email: 'jane@example.com', age: 25 }
];
let nextId = 3;

// GET all users
app.get('/api/users', (req, res) => {
    const { page = 1, limit = 10, search } = req.query;
    
    let filteredUsers = users;
    
    // Search filter
    if (search) {
        filteredUsers = users.filter(u => 
            u.name.toLowerCase().includes(search.toLowerCase()) ||
            u.email.toLowerCase().includes(search.toLowerCase())
        );
    }
    
    // Pagination
    const startIndex = (page - 1) * limit;
    const endIndex = page * limit;
    const paginatedUsers = filteredUsers.slice(startIndex, endIndex);
    
    res.json({
        data: paginatedUsers,
        pagination: {
            page: parseInt(page),
            limit: parseInt(limit),
            total: filteredUsers.length
        }
    });
});

// GET user by ID
app.get('/api/users/:id', (req, res) => {
    const user = users.find(u => u.id === parseInt(req.params.id));
    
    if (!user) {
        return res.status(404).json({ error: 'User not found' });
    }
    
    res.json(user);
});

// POST create user
app.post('/api/users', (req, res) => {
    const { name, email, age } = req.body;
    
    // Validation
    if (!name || !email) {
        return res.status(400).json({ 
            error: 'Name and email are required' 
        });
    }
    
    if (age && (age < 0 || age > 150)) {
        return res.status(400).json({ 
            error: 'Age must be between 0 and 150' 
        });
    }
    
    // Check duplicate email
    if (users.some(u => u.email === email)) {
        return res.status(409).json({ 
            error: 'Email already exists' 
        });
    }
    
    const newUser = {
        id: nextId++,
        name,
        email,
        age: age || null
    };
    
    users.push(newUser);
    res.status(201).json(newUser);
});

// PUT update user
app.put('/api/users/:id', (req, res) => {
    const userId = parseInt(req.params.id);
    const userIndex = users.findIndex(u => u.id === userId);
    
    if (userIndex === -1) {
        return res.status(404).json({ error: 'User not found' });
    }
    
    const { name, email, age } = req.body;
    
    // Validation
    if (!name || !email) {
        return res.status(400).json({ 
            error: 'Name and email are required' 
        });
    }
    
    // Check duplicate email (excluding current user)
    if (users.some(u => u.email === email && u.id !== userId)) {
        return res.status(409).json({ 
            error: 'Email already exists' 
        });
    }
    
    users[userIndex] = {
        ...users[userIndex],
        name,
        email,
        age: age || null
    };
    
    res.json(users[userIndex]);
});

// PATCH partial update
app.patch('/api/users/:id', (req, res) => {
    const userId = parseInt(req.params.id);
    const userIndex = users.findIndex(u => u.id === userId);
    
    if (userIndex === -1) {
        return res.status(404).json({ error: 'User not found' });
    }
    
    users[userIndex] = { ...users[userIndex], ...req.body };
    res.json(users[userIndex]);
});

// DELETE user
app.delete('/api/users/:id', (req, res) => {
    const userId = parseInt(req.params.id);
    const userIndex = users.findIndex(u => u.id === userId);
    
    if (userIndex === -1) {
        return res.status(404).json({ error: 'User not found' });
    }
    
    users.splice(userIndex, 1);
    res.json({ message: 'User deleted successfully' });
});

app.listen(3000, () => {
    console.log('Server running on port 3000');
});</code></pre>
            </div>

            <div class="content-section">
                <h2><i class="fas fa-shield-alt"></i> Middleware</h2>
                <pre><code>const express = require('express');
const app = express();

// Built-in middleware
app.use(express.json());
app.use(express.static('public'));

// Custom logging middleware
const logger = (req, res, next) => {
    console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
    next(); // Call next middleware
};

app.use(logger);

// Authentication middleware
const authenticateToken = (req, res, next) => {
    const token = req.headers['authorization'];
    
    if (!token) {
        return res.status(401).json({ error: 'No token provided' });
    }
    
    // Verify token (simplified)
    if (token !== 'Bearer valid-token') {
        return res.status(403).json({ error: 'Invalid token' });
    }
    
    req.user = { id: 1, name: 'John' }; // Attach user to request
    next();
};

// Error handling middleware
const errorHandler = (err, req, res, next) => {
    console.error(err.stack);
    
    res.status(err.status || 500).json({
        error: {
            message: err.message || 'Internal Server Error',
            ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
        }
    });
};

// Apply middleware to specific routes
app.get('/public', (req, res) => {
    res.json({ message: 'Public endpoint' });
});

app.get('/protected', authenticateToken, (req, res) => {
    res.json({ message: 'Protected data', user: req.user });
});

// Must be last
app.use(errorHandler);</code></pre>
            </div>

            <div class="content-section">
                <h2><i class="fas fa-sitemap"></i> Router & Route Organization</h2>
                <pre><code>// routes/users.js
const express = require('express');
const router = express.Router();

router.get('/', (req, res) => {
    res.json({ message: 'Get all users' });
});

router.get('/:id', (req, res) => {
    res.json({ message: `Get user ${req.params.id}` });
});

router.post('/', (req, res) => {
    res.json({ message: 'Create user' });
});

module.exports = router;

// routes/posts.js
const express = require('express');
const router = express.Router();

router.get('/', (req, res) => {
    res.json({ message: 'Get all posts' });
});

router.get('/:id', (req, res) => {
    res.json({ message: `Get post ${req.params.id}` });
});

module.exports = router;

// app.js
const express = require('express');
const userRoutes = require('./routes/users');
const postRoutes = require('./routes/posts');

const app = express();

app.use(express.json());

// Mount routers
app.use('/api/users', userRoutes);
app.use('/api/posts', postRoutes);

app.listen(3000);</code></pre>
            </div>

            <div class="content-section">
                <h2><i class="fas fa-check-square"></i> Request Validation</h2>
                <pre><code>// Install express-validator
// npm install express-validator

const { body, validationResult, param, query } = require('express-validator');

// Validation middleware
const validateUser = [
    body('name')
        .trim()
        .notEmpty().withMessage('Name is required')
        .isLength({ min: 2, max: 50 }).withMessage('Name must be 2-50 characters'),
    
    body('email')
        .trim()
        .notEmpty().withMessage('Email is required')
        .isEmail().withMessage('Invalid email format')
        .normalizeEmail(),
    
    body('age')
        .optional()
        .isInt({ min: 0, max: 150 }).withMessage('Age must be between 0 and 150')
];

const handleValidationErrors = (req, res, next) => {
    const errors = validationResult(req);
    
    if (!errors.isEmpty()) {
        return res.status(400).json({ 
            errors: errors.array().map(err => ({
                field: err.path,
                message: err.msg
            }))
        });
    }
    
    next();
};

// Use in route
app.post('/api/users',
    validateUser,
    handleValidationErrors,
    (req, res) => {
        // Data is validated
        const { name, email, age } = req.body;
        res.json({ message: 'User created', data: { name, email, age } });
    }
);

// Validate path parameters
app.get('/api/users/:id',
    param('id').isInt().withMessage('ID must be an integer'),
    handleValidationErrors,
    (req, res) => {
        res.json({ id: req.params.id });
    }
);

// Validate query parameters
app.get('/api/search',
    query('q').notEmpty().withMessage('Search query is required'),
    query('page').optional().isInt({ min: 1 }),
    query('limit').optional().isInt({ min: 1, max: 100 }),
    handleValidationErrors,
    (req, res) => {
        res.json({ query: req.query });
    }
);</code></pre>
            </div>

            <div class="content-section">
                <h2><i class="fas fa-file-upload"></i> File Upload with Multer</h2>
                <pre><code>// npm install multer
const express = require('express');
const multer = require('multer');
const path = require('path');

const app = express();

// Configure storage
const storage = multer.diskStorage({
    destination: (req, file, cb) => {
        cb(null, 'uploads/');
    },
    filename: (req, file, cb) => {
        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
        cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
    }
});

// File filter
const fileFilter = (req, file, cb) => {
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
    
    if (allowedTypes.includes(file.mimetype)) {
        cb(null, true);
    } else {
        cb(new Error('Invalid file type. Only JPEG, PNG and GIF allowed.'));
    }
};

const upload = multer({ 
    storage,
    fileFilter,
    limits: {
        fileSize: 5 * 1024 * 1024 // 5MB
    }
});

// Single file upload
app.post('/upload', upload.single('file'), (req, res) => {
    if (!req.file) {
        return res.status(400).json({ error: 'No file uploaded' });
    }
    
    res.json({
        message: 'File uploaded successfully',
        file: {
            filename: req.file.filename,
            size: req.file.size,
            mimetype: req.file.mimetype
        }
    });
});

// Multiple files upload
app.post('/upload-multiple', upload.array('files', 5), (req, res) => {
    res.json({
        message: `${req.files.length} files uploaded`,
        files: req.files.map(f => ({
            filename: f.filename,
            size: f.size
        }))
    });
});

// Multiple fields
app.post('/upload-mixed', 
    upload.fields([
        { name: 'avatar', maxCount: 1 },
        { name: 'photos', maxCount: 5 }
    ]),
    (req, res) => {
        res.json({
            avatar: req.files['avatar'] ? req.files['avatar'][0] : null,
            photos: req.files['photos'] || []
        });
    }
);</code></pre>
            </div>

            <div class="content-section">
                <h2><i class="fas fa-database"></i> Database Integration</h2>
                <pre><code>// With PostgreSQL
const { Pool } = require('pg');

const pool = new Pool({
    host: 'localhost',
    port: 5432,
    database: 'mydb',
    user: 'postgres',
    password: 'password'
});

app.get('/api/users', async (req, res) => {
    try {
        const result = await pool.query('SELECT * FROM users');
        res.json(result.rows);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

app.post('/api/users', async (req, res) => {
    const { name, email } = req.body;
    
    try {
        const result = await pool.query(
            'INSERT INTO users (name, email) VALUES ($1, $2) RETURNING *',
            [name, email]
        );
        res.status(201).json(result.rows[0]);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});</code></pre>
            </div>

            <div class="content-section">
                <h2><i class="fas fa-check-circle"></i> Best Practices</h2>
                <div class="tip-box">
                    <ul>
                        <li>✅ Use environment variables for configuration</li>
                        <li>✅ Implement proper error handling middleware</li>
                        <li>✅ Use async/await for asynchronous operations</li>
                        <li>✅ Organize routes with Express Router</li>
                        <li>✅ Validate and sanitize user input</li>
                        <li>✅ Use helmet for security headers</li>
                        <li>✅ Implement rate limiting for public APIs</li>
                        <li>✅ Use compression middleware for performance</li>
                        <li>✅ Enable CORS properly</li>
                        <li>✅ Log requests and errors</li>
                    </ul>
                </div>
            </div>

            <div class="navigation-links">
                <a href="nestjs.html" class="nav-link">Next: NestJS <i class="fas fa-arrow-right"></i></a>
            </div>
        </main>
    </div>

    <script>
        fetch('../../index.html')
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const sidebar = doc.querySelector('.sidebar');
                if (sidebar) {
                    document.getElementById('sidebarContainer').appendChild(sidebar);
                    const event = new Event('sidebarLoaded');
                    document.dispatchEvent(event);
                }
            });
    </script>
    <script src="../../js/main.js"></script>
</body>

</html>